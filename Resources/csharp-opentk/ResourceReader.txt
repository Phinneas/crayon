using System.Collections.Generic;
using System.Drawing;
using System.IO;
using System.Linq;
using System.Text;

namespace %%%PROJECT_ID%%%
{
	internal static class ResourceReader
	{
        private static Dictionary<string, string> resourceMapping = null;
        
		public static string ReadTextResource(string path)
		{
            // TODO: user path translation
			return ReadTextFile(path);
		}

        private static string GetResourcePath(string userDefinedPath)
        {
            if (resourceMapping == null)
            {
                // also create a type lookup dictionry
                resourceMapping = new Dictionary<string, string>();
                foreach (string line in ReadTextFile("Resources/ResourceMapping.txt").Split('\n'))
                {
                    string[] parts = line.Split(',');
                    switch (parts[0].Trim())
                    {
                        case "TXT":
                            if (parts.Length >= 3)
                            {
                                string resourceName = "Resources/Text/" + parts[1].Trim();
                                string originalName = parts[2];
                                for (int i = 3; i < parts.Length; ++i)
                                {
                                    originalName += "," + parts[i];
                                }
                                originalName = originalName.Trim();
                                resourceMapping[originalName] = resourceName;
                                resourceMapping["/" + originalName] = resourceName;
                            }
                            break;
                    }
                }
            }

            userDefinedPath = userDefinedPath.Replace('\\', '/');
            if (resourceMapping.ContainsKey(userDefinedPath))
            {
                return resourceMapping[userDefinedPath];
            }
            return null;
        }

		public static string ReadTextFile(string path)
		{
			IList<byte> bytes = ReadBytes(path);
            if (bytes == null) return null;
            bool hasBom = bytes.Count >= 3 && bytes[0] == 239 && bytes[1] == 187 && bytes[2] == 191;
			StringBuilder output = new StringBuilder(bytes.Count); 
			output.Append(bytes.Skip<byte>(hasBom ? 3 : 0).Select<byte, char>(b => (char)b).ToArray<char>());
			return output.ToString();
		}

		public static string ReadByteCodeFile()
		{
			return ReadTextFile("Resources/ByteCode.txt");
		}

		public static System.Drawing.Bitmap ReadImageFile(string path)
		{
			IList<byte> data = ReadBytes(path);
			if (data == null)
			{
				return null;
			}
			return new Bitmap(Bitmap.FromStream(new MemoryStream(data.ToArray<byte>())));
		}

		public static System.IO.Stream GetResourceStream(string path)
		{
            System.Reflection.Assembly assembly = typeof(ResourceReader).Assembly;
			path = assembly.GetName().Name + "." + path.Replace('\\', '.').Replace('/', '.').TrimStart('.');
			return assembly.GetManifestResourceStream(path);
		}

		private const int BUFFER_LENGTH = 1000;
		private static readonly byte[] BUFFER = new byte[BUFFER_LENGTH];

		public static List<byte> ReadBytes(string path)
		{
			System.IO.Stream stream = GetResourceStream(path);
			if (stream == null)
			{
				return null;
			}
			StringBuilder sb = new StringBuilder();
			List<byte> output = new List<byte>();

			int bytesRead = 1;
			while (bytesRead > 0)
			{
				bytesRead = stream.Read(BUFFER, 0, BUFFER_LENGTH);
				if (bytesRead == BUFFER_LENGTH)
				{
					output.AddRange(BUFFER);
				}
				else
				{
					for (int i = 0; i < bytesRead; ++i)
					{
						output.Add(BUFFER[i]);
					}
					bytesRead = 0;
				}
			}
			return output;
		}
	}
}
